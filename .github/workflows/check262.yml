name: Check Test262 Properties

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions: read-all

jobs:
  check262:
    runs-on: ubuntu-latest
    name: Check262 Tests
    steps:
    - name: Check out Rhino
      uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.2.2
    - name: Check out test262
      run: git submodule update --init --single-branch
    - name: Set up Java
      uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
      with:
        java-version: 11
        distribution: 'adopt'
    - name: Check current state of properties file
      id: hashBefore
      run: echo "hash=${{ hashFiles('./tests/testsrc/test262.properties') }}" >> $GITHUB_OUTPUT
    - name: Run test262 tests
      run: >-
        ./gadlew :tests:test --tests Test262SuiteTest -DupdateTest262properties
    - name: Check updated state of properties file
      id: hashAfter
      run: echo "hash=${{ hashFiles('./tests/testsrc/test262.properties') }}" >> $GITHUB_OUTPUT
    - name: Compare results
      run: |
        if [ "${{ steps.hashBefore.outputs.hash }}" != "${{ steps.hashAfter.outputs.hash }}" ]; then
          echo "The test262.properties file was not updated properly."
          echo "Please follow the instructions in tests/README.md to update it."
          git --no-pager diff ./tests/testsrc/test262.properties
          exit 1
        else
          echo "The test262.properties file is up to date."
        fi
